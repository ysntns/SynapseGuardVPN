name: Android Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-disabled: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Determine build type
        id: build_type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.build_type }}" >> $GITHUB_OUTPUT
          else
            echo "type=debug" >> $GITHUB_OUTPUT
          fi

      - name: Prepare signing config (Release only)
        if: steps.build_type.outputs.type == 'release'
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          missing_secrets=()
          [ -z "$RELEASE_KEYSTORE_BASE64" ] && missing_secrets+=("RELEASE_KEYSTORE_BASE64")
          [ -z "$RELEASE_STORE_PASSWORD" ] && missing_secrets+=("RELEASE_STORE_PASSWORD")
          [ -z "$RELEASE_KEY_ALIAS" ] && missing_secrets+=("RELEASE_KEY_ALIAS")
          [ -z "$RELEASE_KEY_PASSWORD" ] && missing_secrets+=("RELEASE_KEY_PASSWORD")

          if [ ${#missing_secrets[@]} -ne 0 ]; then
            printf 'Missing required secrets: %s\n' "${missing_secrets[*]}" >&2
            exit 1
          fi

          mkdir -p .signing
          echo "$RELEASE_KEYSTORE_BASE64" | base64 --decode > .signing/release.keystore

          {
            echo "releaseStoreFile=${GITHUB_WORKSPACE}/.signing/release.keystore"
            echo "releaseStorePassword=${RELEASE_STORE_PASSWORD}"
            echo "releaseKeyAlias=${RELEASE_KEY_ALIAS}"
            echo "releaseKeyPassword=${RELEASE_KEY_PASSWORD}"
          } >> gradle.properties
        shell: bash

      - name: Build Debug APK
        if: steps.build_type.outputs.type == 'debug'
        run: ./gradlew assembleDebug --no-daemon

      - name: Build Release APK
        if: steps.build_type.outputs.type == 'release'
        run: ./gradlew assembleRelease --no-daemon

      - name: Upload Debug APK
        if: steps.build_type.outputs.type == 'debug'
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk

      - name: Upload Release APK
        if: steps.build_type.outputs.type == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
