name: Android Build

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-disabled: true

      - name: Install Node dependencies
        run: npm ci || npm install

      - name: Grant execute permission for gradlew
        run: chmod +x android/gradlew

      - name: Determine build type
        id: build_type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.build_type }}" >> $GITHUB_OUTPUT
          else
            echo "type=debug" >> $GITHUB_OUTPUT
          fi

      - name: Prepare signing config (Release only)
        if: steps.build_type.outputs.type == 'release'
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          missing_secrets=()
          [ -z "$KEYSTORE_BASE64" ] && missing_secrets+=("KEYSTORE_BASE64")
          [ -z "$KEYSTORE_PASSWORD" ] && missing_secrets+=("KEYSTORE_PASSWORD")
          [ -z "$KEY_ALIAS" ] && missing_secrets+=("KEY_ALIAS")
          [ -z "$KEY_PASSWORD" ] && missing_secrets+=("KEY_PASSWORD")

          if [ ${#missing_secrets[@]} -ne 0 ]; then
            printf 'Missing required secrets: %s\n' "${missing_secrets[*]}" >&2
            exit 1
          fi

          mkdir -p .signing
          echo "$KEYSTORE_BASE64" | base64 --decode > .signing/release.keystore

          {
            echo "releaseStoreFile=${GITHUB_WORKSPACE}/.signing/release.keystore"
            echo "releaseStorePassword=${KEYSTORE_PASSWORD}"
            echo "releaseKeyAlias=${KEY_ALIAS}"
            echo "releaseKeyPassword=${KEY_PASSWORD}"
          } >> android/gradle.properties
        shell: bash

      - name: Build Debug APK
        if: steps.build_type.outputs.type == 'debug'
        working-directory: android
        run: ./gradlew assembleDebug --no-daemon

      - name: Build Release APK
        if: steps.build_type.outputs.type == 'release'
        working-directory: android
        run: ./gradlew assembleRelease --no-daemon

      - name: Upload Debug APK
        if: steps.build_type.outputs.type == 'debug'
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: android/app/build/outputs/apk/debug/*.apk

      - name: Upload Release APK
        if: steps.build_type.outputs.type == 'release'
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: android/app/build/outputs/apk/release/*.apk
