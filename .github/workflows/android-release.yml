name: Android Release Build

on:
  workflow_dispatch:
  push:
    branches: [ work ]

jobs:
  assemble:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Configure Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Prepare signing config
        env:
          RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
          RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          missing_secrets=()
          [ -z "$RELEASE_KEYSTORE_BASE64" ] && missing_secrets+=("RELEASE_KEYSTORE_BASE64")
          [ -z "$RELEASE_STORE_PASSWORD" ] && missing_secrets+=("RELEASE_STORE_PASSWORD")
          [ -z "$RELEASE_KEY_ALIAS" ] && missing_secrets+=("RELEASE_KEY_ALIAS")
          [ -z "$RELEASE_KEY_PASSWORD" ] && missing_secrets+=("RELEASE_KEY_PASSWORD")

          if [ ${#missing_secrets[@]} -ne 0 ]; then
            printf 'Missing required secrets: %s\n' "${missing_secrets[*]}" >&2
            exit 1
          fi

          mkdir -p .signing
          echo "$RELEASE_KEYSTORE_BASE64" | base64 --decode > .signing/release.keystore

          {
            echo "releaseStoreFile=${GITHUB_WORKSPACE}/.signing/release.keystore"
            echo "releaseStorePassword=${RELEASE_STORE_PASSWORD}"
            echo "releaseKeyAlias=${RELEASE_KEY_ALIAS}"
            echo "releaseKeyPassword=${RELEASE_KEY_PASSWORD}"
          } >> gradle.properties
        shell: bash

      - name: Build release APK
        run: ./gradlew assembleRelease

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app/build/outputs/apk/release/*.apk
